on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: mobiledevops/flutter-sdk-image:latest
      options: --user root # Это оставляем для обхода проблем с правами и git dubious ownership

    steps:
    - uses: actions/checkout@v4

    # Проблема 'dubious ownership' (если она еще возникает)
    # Если запуск с '--user root' не помог решить проблему "dubious ownership",
    # то этот шаг может быть необходим.
    # Если вы используете '--user root', то владелец всех файлов внутри контейнера будет root,
    # и Git не должен выдавать предупреждения о "dubious ownership" для файлов, принадлежащих root.
    # - name: Configure Git safe directory (if needed)
    #   run: git config --global --add safe.directory /home/mobiledevops/.flutter-sdk
    #   working-directory: ${{ github.workspace }} # Выполняем из корня проекта

    - name: Get Flutter dependencies
      run: flutter pub get
      working-directory: ${{ github.workspace }} # Явно указываем рабочую директорию для этого шага

    - name: Build Android APK
      # Ключевое решение для "Must provide Flutter source directory":
      # Явно указываем Flutter CLI, где находится корень проекта.
      run: flutter build apk --debug --project-directory="${{ github.workspace }}"
      working-directory: ${{ github.workspace }} # Явно указываем рабочую директорию для этого шага

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: camera-app-debug
        path: ${{ github.workspace }}/build/app/outputs/flutter-apk/app-debug.apk
